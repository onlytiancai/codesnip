<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kvdv test</title>
</head>

<body>
    <script>
        async function httpRange(url, start, end) {
            const res = await fetch(url, {
                headers: { Range: `bytes=${start}-${end - 1}` }
            });
            return new Uint8Array(await res.arrayBuffer());
        }

        async function loadIndex(url) {
            console.log('Loading index from', url);
            // Read first 4 bytes = N
            const header = await httpRange(url, 0, 4);
            const N = new DataView(header.buffer).getUint32(0, true);
            console.log('Found', N, 'items in database');

            // IndexTable = 8 * N bytes (keyHash + offset)
            const indexBytes = await httpRange(url, 4, 4 + 8 * N);
            const dv = new DataView(indexBytes.buffer);

            // Calculate data area offset: 4 bytes (N) + 8*N bytes (index table)
            const dataAreaOffset = 4 + 8 * N;
            console.log('Data area offset:', dataAreaOffset);

            const index = [];
            for (let i = 0; i < N; i++) {
                const h = dv.getUint32(i * 8, true);
                const off = dv.getUint32(i * 8 + 4, true) + dataAreaOffset; // Add data area offset
                index.push({ h, off });
            }
            console.log('Loaded index with adjusted offsets:', index);
            return index;
        }

        function hash32(str) {
            // Very simple 32-bit hash
            let h = 0;
            for (let i = 0; i < str.length; i++)
                h = (h * 31 + str.charCodeAt(i)) >>> 0;
            return h;
        }

        async function kvGet(url, index, key) {
            console.log('\n=== kvGet called with key:', key, '===');
            const h = hash32(key);
            console.log('Generated hash:', h);

            // binary search keyHash in index
            let lo = 0, hi = index.length - 1, pos = -1;
            console.log('Searching in index with', index.length, 'items');
            while (lo <= hi) {
                const mid = (lo + hi) >> 1;
                console.log('Binary search: lo=' + lo + ', hi=' + hi + ', mid=' + mid + ', index[mid].h=' + index[mid].h);
                if (index[mid].h === h) { 
                    pos = mid; 
                    console.log('Found match at position', pos);
                    break; 
                }
                if (index[mid].h < h) lo = mid + 1;
                else hi = mid - 1;
            }
            if (pos < 0) {
                console.log('Key not found');
                return null;
            }

            const start = index[pos].off;
            const end = (pos + 1 < index.length)
                ? index[pos + 1].off
                : null; // last one: load until EOF
            console.log('Value range: start=' + start + ', end=' + end);

            const rangeEndHeader = end !== null ? end : "";
            const rangeHeader = `bytes=${start}-${rangeEndHeader ? rangeEndHeader - 1 : ""}`;
            console.log('Fetching range:', rangeHeader);

            // read value block
            const res = await fetch(url, {
                headers: { Range: rangeHeader }
            });
            console.log('Fetch response status:', res.status);
            const buf = new Uint8Array(await res.arrayBuffer());
            console.log('Fetched bytes:', buf.length);
            
            const value = new TextDecoder().decode(buf);
            console.log('Decoded value:', value);
            
            return value;
        }
        (async () => {
            const url = "./kv.db";

            console.log("Loading index...");
            const index = await loadIndex(url);
            console.log("Index loaded with", index.length, "items");

            // Test with a common word that should be in the ECDICT database
            const testWords = ["hello", "world", "apple", "banana"];
            
            for (const word of testWords) {
                const v = await kvGet(url, index, word);
                console.log(`${word} =`, v ? JSON.parse(v) : null);
            }
        })();

    </script>
</body>

</html>