<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>kvdv test</title>
</head>

<body>
    <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
        <h1>Dictionary Lookup</h1>
        <div style="margin-bottom: 20px;">
            <input type="text" id="wordInput" placeholder="Enter a word" style="padding: 8px; width: 200px;">
            <button id="searchBtn" style="padding: 8px 16px; margin-left: 10px;">Search</button>
        </div>
        <div>
            <h3>Result:</h3>
            <pre id="resultDisplay" style="background: #f4f4f4; padding: 10px; border-radius: 5px; overflow-x: auto;"></pre>
        </div>
    </div>
    <script>
        async function httpRange(url, start, end) {
            const res = await fetch(url, {
                headers: { Range: `bytes=${start}-${end - 1}` }
            });
            return new Uint8Array(await res.arrayBuffer());
        }

        async function loadIndex(url) {
            console.log('Loading index from', url);
            // Read first 4 bytes = N
            const header = await httpRange(url, 0, 4);
            const N = new DataView(header.buffer).getUint32(0, true);
            console.log('Found', N, 'items in database');

            // IndexTable = 8 * N bytes (keyHash + offset)
            const indexBytes = await httpRange(url, 4, 4 + 8 * N);
            const dv = new DataView(indexBytes.buffer);

            // Calculate data area offset: 4 bytes (N) + 8*N bytes (index table)
            const dataAreaOffset = 4 + 8 * N;
            console.log('Data area offset:', dataAreaOffset);

            const index = [];
            for (let i = 0; i < N; i++) {
                const h = dv.getUint32(i * 8, true);
                const off = dv.getUint32(i * 8 + 4, true) + dataAreaOffset; // Add data area offset
                index.push({ h, off });
            }
            console.log('Loaded index with adjusted offsets:', index);
            return index;
        }

        function hash32(str) {
            // Very simple 32-bit hash
            let h = 0;
            for (let i = 0; i < str.length; i++)
                h = (h * 31 + str.charCodeAt(i)) >>> 0;
            return h;
        }

        async function kvGet(url, index, key) {
            console.log('\n=== kvGet called with key:', key, '===');
            const h = hash32(key);
            console.log('Generated hash:', h);

            // binary search keyHash in index
            let lo = 0, hi = index.length - 1, pos = -1;
            console.log('Searching in index with', index.length, 'items');
            while (lo <= hi) {
                const mid = (lo + hi) >> 1;
                console.log('Binary search: lo=' + lo + ', hi=' + hi + ', mid=' + mid + ', index[mid].h=' + index[mid].h);
                if (index[mid].h === h) { 
                    pos = mid; 
                    console.log('Found match at position', pos);
                    break; 
                }
                if (index[mid].h < h) lo = mid + 1;
                else hi = mid - 1;
            }
            if (pos < 0) {
                console.log('Key not found');
                return null;
            }

            const start = index[pos].off;
            const end = (pos + 1 < index.length)
                ? index[pos + 1].off
                : null; // last one: load until EOF
            console.log('Value range: start=' + start + ', end=' + end);

            const rangeEndHeader = end !== null ? end : "";
            const rangeHeader = `bytes=${start}-${rangeEndHeader ? rangeEndHeader - 1 : ""}`;
            console.log('Fetching range:', rangeHeader);

            // read value block
            const res = await fetch(url, {
                headers: { Range: rangeHeader }
            });
            console.log('Fetch response status:', res.status);
            const buf = new Uint8Array(await res.arrayBuffer());
            console.log('Fetched bytes:', buf.length);
            
            const value = new TextDecoder().decode(buf);
            console.log('Decoded value:', value);
            
            return value;
        }
        // Global variables to cache index
        let cachedIndex = null;
        const dbUrl = "./dict.db";

        // Load index once and cache it
        async function loadAndCacheIndex() {
            if (!cachedIndex) {
                console.log("Loading index...");
                cachedIndex = await loadIndex(dbUrl);
                console.log("Index loaded with", cachedIndex.length, "items");
            }
            return cachedIndex;
        }

        // Search function for button click
        async function searchWord() {
            const word = document.getElementById('wordInput').value.trim();
            const resultDisplay = document.getElementById('resultDisplay');
            
            if (!word) {
                resultDisplay.textContent = "Please enter a word.";
                return;
            }
            
            resultDisplay.textContent = "Searching...";
            
            try {
                const index = await loadAndCacheIndex();
                const value = await kvGet(dbUrl, index, word);
                
                if (value) {
                    // Format JSON for better readability
                    const formattedJson = JSON.stringify(JSON.parse(value), null, 2);
                    resultDisplay.textContent = formattedJson;
                } else {
                    resultDisplay.textContent = `Word "${word}" not found.`;
                }
            } catch (error) {
                console.error("Error searching word:", error);
                resultDisplay.textContent = `Error: ${error.message}`;
            }
        }

        // Add event listener to search button
        document.getElementById('searchBtn').addEventListener('click', searchWord);
        
        // Also search on Enter key
        document.getElementById('wordInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchWord();
            }
        });

        // Initialize: load index on page load
        (async () => {
            await loadAndCacheIndex();
            document.getElementById('resultDisplay').textContent = "Index loaded. Ready to search!";
        })();

    </script>
</body>

</html>