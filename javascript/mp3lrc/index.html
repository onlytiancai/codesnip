<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英语阅读</title>
    <style>
        * {
            box-sizing: border-box;
        }

        html {
            font-family: sans-serif;
            font-size: 16px;
            color: #efefef;
        }

        body {
            width: 100vw;
            height: 100vh;
            margin: 0;
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: black;            
        }

        .lyric {
            font-size: 1.5rem;
            font-weight: bolder;
            line-height: 1.5;
            text-align: center;
            max-width: 300px;
            margin-top: 40px;
        }

        .player {
            width: 100%;
            max-width: 300px;
        }

        ul {
            list-style: none;
        }

        .container {
            height: 450px;
            overflow: hidden;
            margin-top: 10px;
        }

        .container ul {
            transition: all 0.6s;
            text-align: center;
        }

        .container li {
            color: #666;
            height: 60px;
            line-height: 30px;
            cursor: pointer;
        }

        .container li:hover {
            color: lightblue;
        }
        .container li.active {
            color: #fff;
        }
    </style>
</head>

<body>
    <h2>新概念英语 2-001</h2>
    <h3>Private Conversation</h3>
    <audio class="player" controls></audio>
    <div class="container">
        <ul class="wordList">
        </ul>
    </div>
    <script>
        !async function main() {
            "use strict";
            const BASE_URL = "http://media.ihuhao.com/%E6%96%B0%E6%A6%82%E5%BF%B5%E8%8B%B1%E8%AF%AD/2/";

            const doms = {
                lyric: document.querySelector(".lyric"),
                player: document.querySelector(".player"),
                ul: document.querySelector("ul"),
                container: document.querySelector(".container")
            };

            doms.player.src = BASE_URL + "01－A Private Conversation.mp3";

            // load lrc file
            const res = await fetch("01－A Private Conversation.lrc");
            const lrc = await res.text();

            const lyrics = parseLyric(lrc);

            // 创建歌词列表
            function createElements() {
                let frag = document.createDocumentFragment(); // 文档片段
                for (let i = 0; i < lyrics.length; i++) {
                    let li = document.createElement("li");
                    li.innerHTML = lyrics[i].text.replace('|', '<br>');
                    li.addEventListener('click', ()=>{
                        doms.player.currentTime = lyrics[i].time;
                    });
                    frag.appendChild(li);
                }
                doms.ul.appendChild(frag);
            }
            createElements();

            // 获取显示窗口的可视高度
            let containerHeight = doms.container.clientHeight;
            // 获取歌词列表的可视高度
            let liHeight = doms.ul.children[0].clientHeight;
            // 设置最大最小偏移量，防止显示效果不佳
            let minOffset = 0;
            let maxOffset = doms.ul.clientHeight - containerHeight;
            // 控制歌词滚动移动的函数
            function setOffset() {      
                const time = doms.player.currentTime;
                const index = syncLyric(lyrics, time);
                // 计算滚动距离
                let offset = liHeight * index - containerHeight / 2 + liHeight / 2;
                if (offset < minOffset) {
                    offset = minOffset;
                };
                if (offset > maxOffset) {
                    offset = maxOffset;
                };
                offset += 10; // 防止最后一行显示不全
                // 滚动
                doms.ul.style.transform = `translateY(-${offset}px)`;
                // 清除之前的active
                let li = doms.ul.querySelector(".active")
                if (li) {
                    li.classList.remove("active");
                }
                // 为当前所唱到的歌词添加active
                li = doms.ul.children[index];
                if (li) {
                    li.classList.add("active");
                }
            };
            // 当audio的播放时间更新时，触发该事件
            doms.player.addEventListener("timeupdate", setOffset);
        }();


        // lrc (String) - lrc file text
        function parseLyric(lrc) {
            // will match "[00:00.00] ooooh yeah!"
            // note: i use named capturing group
            const regex = /^\[(?<time>\d{2}:\d{2}(.\d{2})?)\](?<text>.*)/;

            // split lrc string to individual lines
            const lines = lrc.split("\n");

            const output = [];

            lines.forEach(line => {
                const matches = line.match(regex);

                // if doesn't match, return.
                if (matches == null) return;

                const { time, text } = matches.groups;

                output.push({
                    time: parseTime(time),
                    text: text.trim()
                });

            });

            // parse formated time
            // "03:24.73" => 204.73 (total time in seconds)
            function parseTime(time) {
                const minsec = time.split(":");

                const min = parseInt(minsec[0]) * 60;
                const sec = parseFloat(minsec[1]);

                return min + sec;
            }

            return output;
        }

        // lyrics (Array) - output from parseLyric function
        // time (Number) - current time from audio player
        function syncLyric(lyrics, time) {
            const scores = [];

            lyrics.forEach(lyric => {
                // get the gap or distance or we call it score
                const score = time - lyric.time;

                // we don't want a negative score
                if (score >= 0) scores.push(score);
            });

            if (scores.length == 0) return null;

            // get the smallest value from scores
            const closest = Math.min(...scores);

            // return the index of closest lyric
            return scores.indexOf(closest);
            //https://dev.to/mcanam/javascript-lyric-synchronizer-4i15
        }
    </script>
</body>

</html>