# 根据上面的统计规律设计一个日内策略，先不用给出代码，而是给出策略说明

非常好，这一步是量化研究的关键：
从统计规律 → 策略逻辑。
我们现在已经掌握了玉米期货（10分钟级）在**量价、波动、动能**维度上的实证规律，可以从这些规律中抽象出一个稳健的、可测试的**日内短线策略框架**。

---

# 🎯 策略设计说明：基于量能-波动过滤的日内均值回归与动量混合模型

---

## 一、策略核心逻辑

通过对历史10分钟数据的统计分析，我们得到以下结论：

| 市场状态       | 统计特征         | 策略倾向          |
| ---------- | ------------ | ------------- |
| 正常成交量，低波动  | 均值回归明显，动量弱   | 反转策略有效        |
| 放量、高波动     | 波动聚集、动量延续    | 动量策略有效        |
| 价格与VWAP差距大 | 随机性强，无明显可预测性 | 仅作观察指标，不作为主信号 |

据此，策略采用**“状态识别 + 策略切换”**框架：

> * **平静期（量缩 + 低波动）** → 做均值回归
> * **活跃期（放量 + 高波动）** → 做动量追随

---

## 二、市场状态识别模块

1. **成交量变化率（Volume Change）**

   * 计算：`vol_chg = volume / volume.shift(1) - 1`
   * 判断：

     * 若 `vol_chg > +0.5` → 视为放量状态；
     * 若 `vol_chg < 0` → 视为缩量状态。

2. **波动率指标（ATR or abs_ret）**

   * 计算：`ATR_t = rolling_mean(high - low, n=10)`
   * 判断：

     * 若 `ATR_t > ATR_mean * 1.2` → 高波动；
     * 若 `ATR_t < ATR_mean * 0.8` → 低波动。

3. **市场状态划分**
   形成四类市场状态（四象限）：

   | 状态 | 成交量      | 波动率            | 策略模式 |
   | -- | -------- | -------------- | ---- |
   | A  | 放量 + 高波动 | → 动量追随         |      |
   | B  | 放量 + 低波动 | → 预期波动上升，可准备动量 |      |
   | C  | 缩量 + 高波动 | → 短期波动过度，做反转   |      |
   | D  | 缩量 + 低波动 | → 区间震荡，轻仓反转    |      |

---

## 三、信号生成逻辑

### 1️⃣ 动量信号（Momentum Mode）

**触发条件：**

* 状态 = “放量 + 高波动”（A象限）

**入场逻辑：**

* 若 `close_t > close_{t-3}` 且 `vol_chg > 0.5` → 做多；
* 若 `close_t < close_{t-3}` 且 `vol_chg > 0.5` → 做空；
* 信号强度可按动量幅度或量能增幅加权。

**出场逻辑：**

* 反向信号出现或 ATR 回落至均值下方；
* 或固定止盈止损（例如 2ATR 止损、3ATR 止盈）。

---

### 2️⃣ 均值回归信号（Mean Reversion Mode）

**触发条件：**

* 状态 = “缩量 + 低波动”（D象限）或“缩量 + 高波动”（C象限）

**入场逻辑：**

* 若 `close_t > vwap + k * ATR` → 做空；
* 若 `close_t < vwap - k * ATR` → 做多；
* 参数 `k` 通常取 0.5~1.0。

**出场逻辑：**

* 回归至 VWAP 附近（例如距离 < 0.2ATR）；
* 或到达反向信号区间。

---

### 3️⃣ 过滤与风控

* **时段过滤**：仅交易活跃时段（09:00–11:30, 13:30–15:00, 21:00–23:00）；
* **滑点与手续费控制**：每笔交易假设滑点 0.5tick；
* **持仓时长**：不跨夜，每日收盘前清仓；
* **风险控制**：

  * 最大单笔亏损不超过账户权益的 0.5%；
  * 同时最多允许 2 笔仓位。

---

## 四、策略结构图（逻辑思维导图）

```
                ┌────────────┐
                │ 市场状态识别 │
                └──────┬─────┘
                       │
          ┌────────────┼────────────┐
          │                         │
   (放量+高波动)              (缩量+低波动/高波动)
  Momentum Mode                 Mean Reversion Mode
          │                         │
  ┌───────┴───────┐         ┌──────┴───────┐
  │ 动量信号生成   │         │ VWAP偏离信号 │
  │ 量能过滤确认   │         │ 反转入场条件 │
  └───────┬───────┘         └──────┬───────┘
          │                         │
          ▼                         ▼
     持仓/平仓逻辑             持仓/平仓逻辑
```

---

## 五、策略直觉与可解释性

| 模块     | 来自的统计证据                      | 实际意义     |
| ------ | ---------------------------- | -------- |
| 成交量变化率 | vol_chg 与 abs_ret 正相关 (0.32) | 放量→波动上升  |
| 动量模式   | 极端波动后收益延续                    | 大行情追随有利  |
| 均值回归   | 普通时段收益自相关 ≈ 0                | 小波动震荡结构  |
| ATR过滤  | ATR 与 abs_ret 相关 (0.27)      | 识别活跃/平静期 |
| VWAP参考 | 无明显预测力，但代表中位成交价              | 可作为均值锚点  |

---

## 六、性能预期（根据统计特征的定性估计）

| 指标    | 动量策略（A象限） | 均值回归策略（C/D象限） |
| ----- | --------- | ------------- |
| 胜率    | 48~52%    | 55~60%        |
| 单笔盈亏比 | 1.5~2.0   | 1.0~1.5       |
| 交易频率  | 较低（波动期触发） | 较高（震荡期频繁）     |
| 核心风险  | 假突破、滞后信号  | 震荡扩大导致止损      |

---

## 七、策略进阶思路（可后续扩展）

1. **多周期共振**：在30分钟周期上确认趋势方向；
2. **波动分层交易**：ATR/成交量作为仓位调节器；
3. **加上收益率自相关信号**：在短期回撤后反转；
4. **利用夜盘与日盘差异**：夜盘波动低，可优先均值回归。

---

## 🧭 一句话总结

> 该策略以成交量和波动率为“市场温度计”，
> 在市场冷静时做均值回归，在市场沸腾时做动量追随，
> 用VWAP作中轴参考，ATR作风险控制，形成一个自适应的日内短线系统。

---

是否希望我下一步帮你把这个策略说明转化为**伪代码结构（不含交易细节）**，便于你直接实现？

# 实现

下面给你一个**基于 Backtrader 的简化实现**，把前面设计的“量能-波动自适应 日内动量/均值回归策略”落地成**可回测的最小可运行版本**。
代码尽量精简、注释清晰，便于直接跑回测并做后续扩展。示例假设你的 CSV 路径为：

```
data/C9999.XDCE.10m.20251018.csv
```

**主要特点**

* 使用 `vol_chg`（成交量变化率）与 `ATR` 判定市场状态（放量/缩量、强波动/弱波动）。
* 放量+高波动 → 动量（3-bar 动量）; 缩量 → 均值回归（基于 VWAP ± k*ATR）。
* ATR 用来计算止损/止盈（以 ATR 单位）。
* 仅在你给定的交易时段开新仓，且在每个交易日结束前全部平仓（不持隔夜）。
* 输出交易日志（入/平仓）与回测基本统计。

---

> 运行前请先 `pip install backtrader pandas`（如未安装）。

02.py

---

## 说明与注意事项（重要）

1. **CSV 格式**：脚本中做了一个小 hack —— 把 `amount` 写入 CSV 的第7列并在 `GenericCSVData` 中以 `openinterest` 读取。策略在运行时从 `self.data.amount` 尝试读取（若不存在，会用 `close` 回退）。这是为了避免太多 backtrader 自定义 `lines` 的样板代码；你可以按需把 `amount` 直接映射到自定义数据线以更干净地实现。
2. **头寸单位与合约规格**：这里把仓位 `size` 当作“合约数”，计算方式是把允许风险金额 / 每单位风险（price distance）。实际期货合约还需考虑每点价值、最小变动单位、保证金比率等，生产化时必须替换为合约级别的精确计算。
3. **滑点/手续费**：脚本未模拟滑点与手续费，回测时应使用 `cerebro.broker.setcommission()` 和 slippage 模型。
4. **风险约束**：示例中每笔按 `MAX_POS_RISK` 计算仓位，且同时限制最大并行仓位数。可再加日内最大亏损触发停止交易。
5. **改进点**：把 `amount` 作为真实 VWAP 计算，或将 `atr_mean` 改为历史窗口均值，或用更严谨的交易时段边界（处理跨日夜盘索引）。

---

如果你需要我做任一项后续工作，我可以：

* 把 `amount` 映射成真正的 `self.data.amount`（自定义数据类）并把代码更“正宗化”；
* 加入手续费、滑点与合约乘数后给出更真实仓位计算；
* 把回测结果（逐笔交易、分象限绩效）导出为 CSV/图表；
* 或把策略移植到你偏好的框架（如 Backtesting.py、vectorbt、zipline）——我可以提供相应版本。

你想先做哪一步？
