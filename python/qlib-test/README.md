用qlib设计一个量化策略
- 适合个人小规模资金，比如几十万
- 持股周期一周到几个月
- 持仓股数10只以内
- 使用量价因子，规模因子，财务因子等
- 针对美股市场，只做多不做空

--- 

下面给你一套「能落地」的 Qlib 美股小资金多头策略方案（并已放好可跑的脚本在右侧 Canvas）：

# 设计思路（匹配你的条件）

* 账户规模：适合个人几十万美金量级（示例用 \$100k 起始资金）。
* 持有周期：预测未来4周收益（≈20个交易日），周度调仓；实际持有在 1 周—3 个月区间。
* 仓位与标的：最多持有 10 只，Top-k 持仓 + Dropout 逐步换仓，降低换手。
* 市场与方向：美股，仅做多，基准用 SPY。
* 因子：以 **量价因子（Alpha158）** 为主，补充 **规模/流动性代理**，可选扩展 **财务因子**（在代码里留了 TODO 钩子）。
* 交易与成本：考虑小账户真实成本（单边 15 bps + \$1/笔 + 5 bps 滑点），过滤低价与不够流动的股票（价格≥\$3、60日中位成交额≥\$2M）。

# 因子与目标

* 目标（label）：`Ref($close, -20)/Ref($close, -1)-1` —— 预测未来4周收益。
* 量价：直接用 **Alpha158** 的技术特征（动量、波动、量能、K 线统计等）。
* 自定义补充（代码里已加）：

  * `mom_12_1`（12-1月动量）
  * `rev_5`（5日反转）
  * `vol_60`（60日收益波动）
  * `to_20`（20日平均换手）
  * `dollar_vol_60_log`（60日成交额对数，作为规模/流动性代理）

> 想加**财务因子**（价值/质量/杠杆/盈利能力），在脚本末尾 “TODO: Add fundamental factors” 已写好接入路径：准备季度财务 CSV→与 Alpha158 合并→定义 `btm/ey/gm` 等字段→加入 `custom`。

# 组合构建

* 策略：`TopkDropoutStrategy(topk=10, n_drop=2, buffer_day=5)`
  每周调仓，最多10只；至少持有1周后才允许被替换；每次换掉表现/打分靠后的2只以控换手。
* 风险/约束：

  * 流动性过滤：价≥\$3、60日平均成交额≥\$2M。
  * 权重自然等权（Top-k），风险度 1.0，纯多头满仓。

# 回测设置

* 数据：Qlib US 日频数据（示例路径 `~/.qlib/qlib_data/us_data`，你需先用 Qlib 的 data collector 准备）。
* 时段：训练 2012–2019，验证 2020–2021，测试 2022–2025/07。
* 成本：单边 15 bps + \$1/笔，滑点 5 bps（可按你的券商实际修改）。
* 执行：日频模拟器，收盘价成交（可改 vwap）。

# 你能直接用的代码

我已把完整可跑的示例脚本放在右侧 Canvas：**《Qlib 美股小资金多头策略（Top10，周调仓）示例代码》**。
它包含：

* Qlib 初始化（美股），Alpha158 + 自定义因子，LightGBM 训练与预测
* 流动性过滤、Top-k Dropout 组合、回测与风险指标输出
* 导出 `trades.csv`、`positions.csv` 便于核对交易与持仓

# 使用步骤

1. 准备数据

```bash
# 仅示意，请按 Qlib 官方文档收集美股日频数据
qlib_init_us_data  # 或手动运行 qlib 的 Yahoo 收集脚本
```

2. 安装依赖

```bash
pip install qlib lightgbm
```

3. 修改脚本里数据路径/时间段/成本参数（如有需要），然后运行：

```bash
python us_longonly_top10.py
```

# 调参与实盘化建议

* **调仓频率**：默认周更；若换手偏高，可把 `n_drop` 从 2 降为 1，或把 `buffer_day` 从 5 提到 10。
* **因子稳定性**：动量与质量类更适合 1–3 个月持有；短期反转信号配合更严格的流动性过滤。
* **小资金细节**：设置 `min_cost` 避免碎单；实盘尽量走 **限价单**；开盘/收盘择时可对冲滑点。
* **风险暴露**（可选进阶）：在选股后做行业/市值中性微调；或对极端波动/高杠杆票加权惩罚。
* **过拟合控制**：滚动回测 + 年度切片检验；关注 **IC/Rank IC**、**换手-收益**弹性。

需要的话，我可以帮你把“财务因子接入”的自定义 Handler 也补成可跑版本，并加上简单的网格调参与滚动训练框架。

---

解释几个疑问
- Alpha158 里的所有因子，这个策略用到了哪些？
- 解释 TopkDropoutStrategy
- init_instance_by_config 函数没有定义
- model 和 strategy 有什么关系

---

逐个解释你的问题：

---

### 1. **Alpha158 里的所有因子，这个策略用到了哪些？**

* **Alpha158** 是 Qlib 内置的一个因子库，包含了 **158 个常见的量价因子**（动量、波动率、成交量、换手率等），属于“高频基础因子”集合。
* 在示例策略里，我们并没有手动挑选因子，而是通过

  ```python
  dataset = init_instance_by_config(dataset_config)
  ```

  里的 `dataset_config` 指定了 `handler`（如 `Alpha158`），这样会把 Alpha158 提供的所有因子作为特征输入。
* **换句话说，模型会从 Alpha158 的所有因子里自动学习哪些有用。**
* 如果你想限制只用一部分因子，需要修改 `dataset_config` 里的 `columns` 参数。

---

### 2. **TopkDropoutStrategy**

* 这是 **调仓逻辑 (strategy)**，控制如何从模型预测结果（signal）转化为实际买卖。
* 它的含义：

  * **TopK**：每次从预测分数最高的股票中挑选前 `K` 只进入持仓。
  * **Dropout**：为了避免过度集中或因子漂移，每次会随机丢弃一部分候选股票，提升组合稳定性和多样性。
* 示例里的配置：

  ```python
  {
      "class": "TopkDropoutStrategy",
      "module_path": "qlib.contrib.strategy.signal_strategy",
      "kwargs": {
          "topk": 10,
          "n_drop": 2
      }
  }
  ```

  解释：

  * 每次调仓从预测分数最高的股票里，挑选前 10 只。
  * 然后再随机丢弃 2 只，最终只持有 8 只。

---

### 3. **init\_instance\_by\_config 函数没有定义**

* 这是 Qlib 提供的一个工具函数，用来根据配置字典初始化对象。
* 定义在：

  ```python
  from qlib.utils import init_instance_by_config
  ```
* 用途：比如 `init_instance_by_config(model_config)` 会自动加载相应的模型对象，而不用你手写类名和参数。

---

### 4. **model 和 strategy 有什么关系**

* **model**：负责 **预测**，输入因子 → 输出未来收益预测值。
* **strategy**：负责 **执行**，根据模型输出的预测分数，决定实际的买入卖出（仓位、调仓频率、持仓数等）。
* 二者的关系：

  * 模型预测谁可能涨。
  * 策略决定怎么买、买多少、什么时候卖。
* 在 Qlib 框架里：

  * model = “预测器”
  * strategy = “下单规则”

---

要不要我帮你写一版 **只用量价因子 + 财务因子（剔除纯技术指标）** 的 `dataset_config` 示例，这样更贴合你提的“量价因子、规模因子、财务因子”？
