# æ›´æ–°æ•°æ®

å‚è€ƒé“¾æ¥ï¼šhttps://github.com/microsoft/qlib/tree/main/scripts/data_collector/yahoo

ç»ˆç«¯é‡Œè¦å…ˆè®¾ç½®ä»£ç†ï¼Œå¦åˆ™ yahoo çš„æ•°æ®ä¸‹è½½ä¸ä¸‹æ¥

## 1. ä¸‹è½½åŸå§‹æ•°æ®ï¼Œ

æ—¶é—´è¾ƒä¹…ï¼Œä¼šä¸‹è½½ 5000 å¤šåªè‚¡ç¥¨ä» 2005 åˆ°æœ€è¿‘ä¸€å¤©çš„æ•°æ®ï¼Œç›®æ ‡ç›®å½•æ˜¯ `~/.qlib/stock_data/source/cn_data`

    cd scripts/data_collector/yahoo
    python collector.py download_data --source_dir ~/.qlib/stock_data/source/cn_data

    ls  ~/.qlib/stock_data/source/cn_data | wc -l
        5186

    head -n2 ~/.qlib/stock_data/source/cn_data/sh000300.csv
    date,open,close,high,low,volume,money,change,adjclose,symbol
    2005-01-04,994.77,982.79,994.77,980.66,7412868.0,4431977400.0,0.0,982.79,sh000300        

## 2. å½’ä¸€åŒ–æ•°æ®

ç›®æ ‡ç›®å½•æ˜¯ `~/.qlib/stock_data/source/cn_1d_nor`

    python collector.py normalize_data --source_dir ~/.qlib/stock_data/source/cn_data --normalize_dir ~/.qlib/stock_data/source/cn_1d_nor --region CN --interval 1d

æœŸé—´å¯èƒ½ä¼šæŠ¥é”™ï¼Œä¸»è¦æ˜¯å› ä¸ºåŸå§‹æ•°æ®é‡Œï¼Œæœ‰çš„æ—¶é—´æ ¼å¼ä¸æ­£ç¡®ï¼Œæœ¬æ¥åº”è¯¥åªæœ‰å¹´æœˆæ—¥ï¼Œä½†æœ‰çš„æœ‰å¤©ï¼Œå¯ä»¥å¢åŠ æŠ¥é”™çš„ç›¸å…³æ–‡ä»¶é‡ŒåŠ æ—¥å¿—ï¼Œæ‰“å°å‡ºé”™çš„åŸå§‹æ–‡ä»¶è·¯å¾„ã€‚

ä¸€ç§é—®é¢˜æ˜¯ï¼Œå¦‚æœæ­£åœ¨å¼€ç›˜ï¼Œå®ƒå¯èƒ½ä¼šæ‹‰å–ä»Šå¤©çš„æ•°æ®ï¼Œè¿™æ—¶å€™æœ€åä¸€æ¡æ•°æ®ï¼Œæ ¼å¼æ˜¯æœ‰é—®é¢˜çš„ï¼Œç”¨å¦‚ä¸‹è„šæœ¬åˆ æ‰æ¯ä¸ªæ–‡ä»¶çš„æœ€åä¸€è¡Œï¼Œ

    cd ~/.qlib/stock_data/source/cn_data
    # æ‰§è¡Œå‰è®°å¾—å¤‡ä»½æ•´ä¸ªç›®å½•
    for f in *.csv; do
        sed -i '' '/2025-09-01/d' "$f"
    done

å¯èƒ½è¿˜æœ‰ä¸€äº›æ–‡ä»¶çš„æŸäº›è¡Œçš„æ—¥æœŸæ ¼å¼ä¸æ­£ç¡®ï¼Œç»§ç»­ç”¨ sed æ¸…ç†

    for f in *.csv; do                  
        sed -E -i '' 's/([0-9]{4}-[0-9]{2}-[0-9]{2}) [0-9]{2}:[0-9]{2}:[0-9]{2}\+08:00/\1/g' "$f"
    done

å†æœ‰é—®é¢˜å°±æ˜¯æ¯”è¾ƒå°‘çš„é—®é¢˜äº†ï¼Œæ‰‹å·¥ä¿®å¤å³å¯

## è½¬æ¢æˆ qlib bin æ ¼å¼

è¿™ä¸€æ­¥ä¸€èˆ¬æ²¡å•¥é”™


    python dump_bin.py dump_all --data_path ~/.qlib/stock_data/source/cn_1d_nor --qlib_dir ~/.qlib/qlib_data/cn_data --freq day --exclude_fields date,symbol --file_suffix .csv

## æ›´æ–° instruments æ–‡ä»¶

é»˜è®¤ instruments é…ç½®åœ¨ `~/.qlib/qlib_data/cn_data/instruments` è·¯å¾„ä¸‹ï¼Œä¹Ÿéœ€è¦æ›´æ–°ï¼Œå¦åˆ™ dataset åŠ è½½æ•°æ®åŠ è½½ä¸å…¨ï¼Œå³ä½¿åŸå§‹æ•°æ®å·²ç»å…¨äº†

    ls ~/.qlib/qlib_data/cn_data/instruments
    all.txt		csi100.txt	csi300.txt	csi500.txt
    head ~/.qlib/qlib_data/cn_data/instruments/csi100.txt
    SH600000	2007-05-29	2020-10-20
    SH600009	2018-06-11	2020-10-20
    SH600015	2007-05-29	2020-10-20
    SH600016	2007-05-29	2020-10-20

è¿›å…¥å¦‚ä¸‹ç›®å½•ï¼Œå¹¶æ‰§è¡Œè„šæœ¬æ›´æ–° instrumentsï¼Œè¦å•ç‹¬å®‰è£…ä¸€äº› excel ç›¸å…³çš„ä¾èµ–

    cd /Users/huhao/src/qlib/scripts/data_collector/cn_index
    python collector.py --index_name csi300 --qlib_dir ~/.qlib/qlib_data/cn_data --method parse_instruments

## æ£€æŸ¥æ•°æ®

å®ƒä¼šæ£€æŸ¥æ˜¯å¦æœ‰ç¼ºå¤±å€¼ï¼Œæ˜¯å¦æœ‰ä¸åˆå¸¸ç†çš„ç¦»ç¾¤å€¼ï¼Œæ¯”è¾ƒå¤§çš„æ³¢åŠ¨ç­‰ã€‚

    python scripts/check_data_health.py check_data --qlib_dir ~/.qlib/qlib_data/cn_data

## æ•°æ®éªŒè¯

ä»¥ä¸‹ä»£ç å¯æµ‹è¯•èƒ½å¦åŠ è½½åˆ°æœ€æ–°çš„æ•°æ®

    import qlib
    from qlib.data import D
    from qlib.contrib.data.handler import Alpha158

    # ---------------------------
    # 1. åˆå§‹åŒ–ï¼Œç¡®ä¿ provider_uri æŒ‡å‘æ­£ç¡®çš„è·¯å¾„
    # ---------------------------
    qlib.init(provider_uri="~/.qlib/qlib_data/cn_data", region="cn")  # ğŸ‘ˆ æ”¹æˆä½ å®é™…çš„æ•°æ®ç›®å½•

    stocks = ["SH600519", "SZ000001", "SZ300750"]
    instruments = D.instruments(stocks)
    instruments = D.instruments('csi300') # å¦‚æœä¸æ›´æ–° instrumentsï¼Œè¿™æ ·ç”¨ csi300 åŠ è½½æ•°æ®ä¼šåŠ è½½ä¸åˆ°æœ€æ–°æ•°æ®

    # ---------------------------
    # 2. æ£€æŸ¥åŸå§‹è¡Œæƒ…æ•°æ®çš„æœ€åæ—¥æœŸ
    # ---------------------------
    df_raw = D.features(instruments, ["$close"], freq="day")
    print("åŸå§‹è¡Œæƒ…æœ€åæ—¥æœŸ:", df_raw.index.get_level_values("datetime").max())

    # ---------------------------
    # 3. æ£€æŸ¥ Alpha158 handler çš„æœ€åæ—¥æœŸ
    # ---------------------------
    data_handler_config = {
        "start_time": "2008-01-01",
        "end_time": "2025-08-25",      # å°½é‡å†™æœ€æ–°
        "fit_start_time": "2008-01-01",
        "fit_end_time": "2025-08-25",
        "instruments": instruments,
    }

    h = Alpha158(**data_handler_config)
    df_label = h.fetch(col_set="label")
    print("Alpha158 Label æœ€åæ—¥æœŸ:", df_label.index.get_level_values("datetime").max())

    # ---------------------------
    # 4. å¦‚æœéœ€è¦ï¼Œä¹Ÿå¯ä»¥æ£€æŸ¥ feature çš„æœ€åæ—¥æœŸ
    # ---------------------------
    df_feat = h.fetch(col_set="feature")
    print("Alpha158 Feature æœ€åæ—¥æœŸ:", df_feat.index.get_level_values("datetime").max())